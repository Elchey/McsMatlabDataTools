<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of scatterSpikeRate</title>
  <meta name="keywords" content="scatterSpikeRate">
  <meta name="description" content="Very experimental function to visualize spike rates">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">+McsHDF5</a> &gt; <a href="index.html">@McsFrameDataEntity</a> &gt; scatterSpikeRate.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for +McsHDF5/@McsFrameDataEntity&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>scatterSpikeRate
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Very experimental function to visualize spike rates</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function scatterSpikeRate(fde,cfg,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Very experimental function to visualize spike rates

 function scatterSpikeRate(fde,cfg,varargin)

 This function provides a possibility to visualize spike rates in data
 recorded in a 2D electrode array, i.e. a frame stream. It performs a
 simple, threshold based spike detection on the raw data. This detection
 is done channel-wise to save memory. The result is transformed to
 channel-wise spike rates which are shown in a 3D plot. In this plot,
 rates &gt; 0 are plotted as open circles with a radius proportional to the
 rate. A contour function color-codes the the total spike rate per
 channel.

 Input:

   fde         -   A McsFrameDataEntity object.

   cfg         -   Either empty (for default parameters) or a
                   structure with (some of) the following fields:
                   'channelMatrix': empty for all channels, otherwise a
                       matrix of bools with size channels_x x channels_y.
                       All channels with 'true' entries in this matrix are
                       used in the plots. (default: all channels)
                   'window': empty for the whole time range, otherwise
                       a vector with two entries: [start end] of the time
                       range, both in seconds.
                   'spikeBaselineSegment': [start end] in seconds of the
                       time range used to get a baseline estimation of the
                       noise standard deviation. If empty, the first 100
                       ms are used.
                   'spikeSD': threshold for spike detection in standard
                       deviations. If a data point exceeds
                       cfg.spikeSD*std(signal in cfg.spikeBaselineSegment)
                       after subtraction of the mean, it is counted as a
                       spike.
                   'rateWindow': Length in seconds of the window for spike
                       rate computation.
                   'rateStep': Step size in seconds for moving the rate
                       computation window over the data.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function spikes = detectSpikes(fde,cfg)</a></li><li><a href="#_sub2" class="code">function rates = computeRates(fde,spikes,cfg)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function scatterSpikeRate(fde,cfg,varargin)</a>
0002 <span class="comment">% Very experimental function to visualize spike rates</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% function scatterSpikeRate(fde,cfg,varargin)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% This function provides a possibility to visualize spike rates in data</span>
0007 <span class="comment">% recorded in a 2D electrode array, i.e. a frame stream. It performs a</span>
0008 <span class="comment">% simple, threshold based spike detection on the raw data. This detection</span>
0009 <span class="comment">% is done channel-wise to save memory. The result is transformed to</span>
0010 <span class="comment">% channel-wise spike rates which are shown in a 3D plot. In this plot,</span>
0011 <span class="comment">% rates &gt; 0 are plotted as open circles with a radius proportional to the</span>
0012 <span class="comment">% rate. A contour function color-codes the the total spike rate per</span>
0013 <span class="comment">% channel.</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% Input:</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%   fde         -   A McsFrameDataEntity object.</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%   cfg         -   Either empty (for default parameters) or a</span>
0020 <span class="comment">%                   structure with (some of) the following fields:</span>
0021 <span class="comment">%                   'channelMatrix': empty for all channels, otherwise a</span>
0022 <span class="comment">%                       matrix of bools with size channels_x x channels_y.</span>
0023 <span class="comment">%                       All channels with 'true' entries in this matrix are</span>
0024 <span class="comment">%                       used in the plots. (default: all channels)</span>
0025 <span class="comment">%                   'window': empty for the whole time range, otherwise</span>
0026 <span class="comment">%                       a vector with two entries: [start end] of the time</span>
0027 <span class="comment">%                       range, both in seconds.</span>
0028 <span class="comment">%                   'spikeBaselineSegment': [start end] in seconds of the</span>
0029 <span class="comment">%                       time range used to get a baseline estimation of the</span>
0030 <span class="comment">%                       noise standard deviation. If empty, the first 100</span>
0031 <span class="comment">%                       ms are used.</span>
0032 <span class="comment">%                   'spikeSD': threshold for spike detection in standard</span>
0033 <span class="comment">%                       deviations. If a data point exceeds</span>
0034 <span class="comment">%                       cfg.spikeSD*std(signal in cfg.spikeBaselineSegment)</span>
0035 <span class="comment">%                       after subtraction of the mean, it is counted as a</span>
0036 <span class="comment">%                       spike.</span>
0037 <span class="comment">%                   'rateWindow': Length in seconds of the window for spike</span>
0038 <span class="comment">%                       rate computation.</span>
0039 <span class="comment">%                   'rateStep': Step size in seconds for moving the rate</span>
0040 <span class="comment">%                       computation window over the data.</span>
0041     defaultRateWindow = 0.05;
0042     defaultRateStep = 0.01;
0043 
0044     <span class="keyword">if</span> isempty(cfg)
0045         cfg.window = [];
0046         cfg.channelMatrix = [];
0047         cfg.spikeSD = 5;
0048         cfg.spikeBaselineSegment = [McsHDF5.TickToSec(fde.FrameDataTimeStamps(1)) McsHDF5.TickToSec(fde.FrameDataTimeStamps(1))+0.1];
0049         cfg.rateWindow = defaultRateWindow;
0050         cfg.rateStep = defaultRateStep;    
0051     <span class="keyword">end</span>
0052     
0053     <span class="keyword">if</span> ~isfield(cfg,<span class="string">'window'</span>)
0054         cfg.window = [];
0055     <span class="keyword">end</span>
0056     
0057     <span class="keyword">if</span> ~isfield(cfg,<span class="string">'channelMatrix'</span>)
0058         cfg.channelMatrix = [];
0059     <span class="keyword">end</span>
0060     
0061     <span class="keyword">if</span> isempty(cfg.window)
0062         cfg.window = McsHDF5.TickToSec([fde.FrameDataTimeStamps(1) fde.FrameDataTimeStamps(end)]);
0063     <span class="keyword">end</span>
0064     <span class="keyword">if</span> isempty(cfg.channelMatrix)
0065         cfg.channelMatrix = true(size(fde.FrameData,2),size(fde.FrameData,3));
0066     <span class="keyword">end</span>
0067     
0068     <span class="keyword">if</span> ~isfield(cfg,<span class="string">'spikeSD'</span>)
0069         cfg.spikeSD = 5;
0070     <span class="keyword">end</span>
0071     
0072     <span class="keyword">if</span> ~isfield(cfg,<span class="string">'spikeBaselineSegment'</span>)
0073         cfg.spikeBaselineSegment = [0 0.1];
0074     <span class="keyword">end</span>
0075     
0076     <span class="keyword">if</span> ~isfield(cfg,<span class="string">'rateWindow'</span>)
0077         cfg.rateWindow = defaultRateWindow;
0078     <span class="keyword">end</span>
0079     
0080     <span class="keyword">if</span> ~isfield(cfg,<span class="string">'rateStep'</span>)
0081         cfg.rateStep = defaultRateStep;
0082     <span class="keyword">end</span>
0083     
0084     <span class="comment">% detect spikes</span>
0085     spikes = <a href="#_sub1" class="code" title="subfunction spikes = detectSpikes(fde,cfg)">detectSpikes</a>(fde,cfg);
0086     
0087     <span class="comment">% compute rate</span>
0088     rates = <a href="#_sub2" class="code" title="subfunction rates = computeRates(fde,spikes,cfg)">computeRates</a>(fde,spikes,cfg);
0089     
0090     <span class="comment">% plot</span>
0091     sz = size(fde.FrameData);
0092     
0093     ratemat = zeros(size(rates,1),sz(2),sz(3));
0094     ratemat(:,cfg.channelMatrix) = rates;
0095     
0096     [X,Y,Z] = meshgrid(1:sz(2),1:sz(3),cfg.window(1)+cfg.rateWindow:cfg.rateStep:cfg.window(2));
0097     
0098     ratemat = shiftdim(ratemat,1);
0099     
0100     xx = X(ratemat &gt; 0);
0101     yy = Y(ratemat &gt; 0);
0102     zz = Z(ratemat &gt; 0);
0103     
0104     <span class="keyword">if</span> isempty(varargin)
0105         scatter3(xx,yy,zz,ratemat(ratemat &gt; 0));
0106     <span class="keyword">else</span>
0107         scatter3(xx,yy,zz,ratemat(ratemat &gt; 0),varargin{:})
0108     <span class="keyword">end</span>
0109     hold on
0110     [XX,YY] = meshgrid(1:sz(3),1:sz(2));
0111     s = squeeze(sum(ratemat,3));
0112     s(s == 0) = NaN;
0113     contourf(XX,YY,s)
0114     hold off
0115     axis([0 sz(2) 0 sz(3) 0 cfg.window(2)])
0116     xlabel(<span class="string">'x channels'</span>)
0117     ylabel(<span class="string">'y channels'</span>)
0118     zlabel(<span class="string">'Time [s]'</span>)
0119 <span class="keyword">end</span>
0120 
0121 <a name="_sub1" href="#_subfunctions" class="code">function spikes = detectSpikes(fde,cfg)</a>
0122 
0123     base_idx = fde.FrameDataTimeStamps &gt;= McsHDF5.SecToTick(cfg.spikeBaselineSegment(1)) &amp; <span class="keyword">...</span>
0124         fde.FrameDataTimeStamps &lt;= McsHDF5.SecToTick(cfg.spikeBaselineSegment(2));
0125     
0126     [~,tstart] = min(abs(fde.FrameDataTimeStamps - McsHDF5.SecToTick(cfg.window(1))));
0127     [~,tend] = min(abs(fde.FrameDataTimeStamps - McsHDF5.SecToTick(cfg.window(2))));
0128     
0129     c = find(cfg.channelMatrix);
0130     
0131     mn = squeeze(mean(fde.FrameData(tstart:tend,c)));
0132     
0133     base_sd = squeeze(sqrt(var(fde.FrameData(base_idx,c))));
0134     
0135     spikes = sparse(length(tstart:tend),numel(c));
0136     
0137     <span class="keyword">for</span> ci = 1:size(c)
0138         chan = c(ci);
0139         spikes(abs(fde.FrameData(tstart:tend,chan)-mn(ci)) &gt; cfg.spikeSD*base_sd(ci),ci) = true;
0140     <span class="keyword">end</span>
0141 
0142 <span class="keyword">end</span>
0143 
0144 <a name="_sub2" href="#_subfunctions" class="code">function rates = computeRates(fde,spikes,cfg)</a>
0145 
0146     Fs = 1 / double(fde.Info.Tick) * 1e6;
0147     
0148     winlen = cfg.rateWindow * Fs;
0149     step = cfg.rateStep * Fs;
0150     
0151     rates = zeros(floor((size(spikes,1)-winlen) / step),size(spikes,2));
0152     count = 0;
0153     <span class="keyword">for</span> i = 1:step:size(spikes,1)-winlen
0154         count = count + 1;
0155         rates(count,:) = sum(spikes(i:i+winlen,:));
0156     <span class="keyword">end</span>
0157 <span class="keyword">end</span>
0158</pre></div>
<hr><address>Generated on Wed 26-Mar-2014 15:28:34 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>